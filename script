local player = game.Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local humanoidRootPart = character:WaitForChild("HumanoidRootPart")
local runService = game:GetService("RunService")
local userInput = game:GetService("UserInputService")
local tweenService = game:GetService("TweenService")
local autoFarm = true
local HIT_RANGE = 10
local heightOffset = -2.5  -- Negative height offset to position under the mob

local function isArcher(mob)
    return mob.Name:lower():find("archer") ~= nil 
end

local function getClosestMob()
    local closestMob = nil
    local closestDistance = math.huge
    for _, mob in ipairs(workspace.Characters:GetChildren()) do
        if mob:IsA("Model") and mob ~= character and mob:FindFirstChild("HumanoidRootPart") then
            local dist = (mob.HumanoidRootPart.Position - humanoidRootPart.Position).Magnitude
            if dist < closestDistance then
                closestDistance = dist
                closestMob = mob
            end
        end
    end
    return closestMob
end

local function isInRange(mob, range)
    local mobRootPart = mob:FindFirstChild("HumanoidRootPart")
    if not mobRootPart or not humanoidRootPart then return false end
    return (mobRootPart.Position - humanoidRootPart.Position).Magnitude <= range
end

local function equipWeapon()
    local args = {
        [1] = "Equip/UnEquip"
    }
    game:GetService("ReplicatedStorage"):WaitForChild("Events"):WaitForChild("WeaponsEvent"):FireServer(unpack(args))
end

equipWeapon()

local function useSkill(skillName)
    local args = {
        [1] = { ["Skill"] = skillName, ["Function"] = "Activate" },
        [2] = humanoidRootPart.Position,
        [3] = true
    }
    game:GetService("ReplicatedStorage"):WaitForChild("Events"):WaitForChild("Skill"):FireServer(unpack(args))
end

local function tweenToMob(mob)
    if not mob or not mob:FindFirstChild("HumanoidRootPart") or not humanoidRootPart then return end
    
    -- Set anchored to false before tweening
    humanoidRootPart.Anchored = false
    
    local mobPosition = mob.HumanoidRootPart.Position
    local targetPosition = mobPosition + Vector3.new(0, heightOffset, 0)  -- Position directly under the mob
    
    -- Create tween info
    local tweenInfo = TweenInfo.new(
        0.2,  -- Time to complete tween
        Enum.EasingStyle.Quad,
        Enum.EasingDirection.Out
    )
    
    -- Create the tween
    local tween = tweenService:Create(
        humanoidRootPart, 
        tweenInfo, 
        {CFrame = CFrame.new(targetPosition, Vector3.new(mobPosition.X, targetPosition.Y, mobPosition.Z))}  -- Face the mob
    )
    
    -- Start the tween
    tween:Play()
    
    -- Wait for tween to complete
    tween.Completed:Wait()
    
    -- Set anchored to true after tweening
    humanoidRootPart.Anchored = true
    
    -- Ensure we're looking at the mob after tweening
    local lookAtPosition = mobPosition
    humanoidRootPart.CFrame = CFrame.lookAt(humanoidRootPart.Position, lookAtPosition)
end

local function attack()
    while autoFarm do
        local mob = getClosestMob()
        if mob and mob:FindFirstChild("HumanoidRootPart") then
            -- Tween to position under the mob
            tweenToMob(mob)
            
            -- Perform attacks
            game:GetService("ReplicatedStorage"):WaitForChild("Events"):WaitForChild("Combat")
                :FireServer("Attack")
            useSkill("FlurryOfBlows")
            useSkill("BloodyCut")
            useSkill("Invisibility")
            
            task.wait(0.1)
        else
            task.wait(0.5)
        end
    end
end

local function stopAutoFarm()
    autoFarm = false
    humanoidRootPart.Anchored = false
end

local function enableNoFall()
    runService.Stepped:Connect(function()
        if autoFarm and humanoidRootPart then
            humanoidRootPart.Velocity = Vector3.new(0, 0, 0)
        end
    end)
end

enableNoFall()
attack()
