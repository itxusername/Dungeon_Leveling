local MacLib = loadstring(game:HttpGet("https://github.com/biggaboy212/Maclib/releases/latest/download/maclib.txt"))()

local Window = MacLib:Window({
    Title = "Night RBX",
    Subtitle = "BETA | V0.1",
    Size = UDim2.fromOffset(868, 650),
    DragStyle = 1,
    DisabledWindowControls = {},
    ShowUserInfo = true,
    Keybind = Enum.KeyCode.RightControl,
    AcrylicBlur = true,
})

-- Set config folder
MacLib:SetFolder("NightRBX_Configs")

local TabGroup = Window:TabGroup()
local Tab = TabGroup:Tab({
    Name = "Combat",
})

Tab:Select()
Tab:InsertConfigSection("Right")

local sections = {
    MainSection1 = Tab:Section({
        Side = "Left"
    })
}

sections.MainSection1:Button({
    Name = "Attack",
    Callback = function()
        print("Attacking.")
    end,
})

local mobRangeSlider = sections.MainSection1:Slider({
    Name = "Mob-Range",
    Default = 3,
    Minimum = 0,
    Maximum = 10,
    DisplayMethod = "Percent",
    Callback = function(Value)
        HIT_RANGE = Value
        print("Changed range to ".. Value)
    end,
}, "Mob_Range")

sections.MainSection1:Toggle({
    Name = "AutoMobTp",
    Default = false,
    Callback = function(value)
        autoFarm = value
        Window:Notify({
            Title = "Kuzu Hub",
            Description = (value and "Enabled " or "Disabled ") .. "Auto Farm"
        })
        if not value then
            stopAutoFarm()
        else
            attack()
        end
    end,
}, "AutoFarmToggle")

local player = game.Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local humanoidRootPart = character:WaitForChild("HumanoidRootPart")

local runService = game:GetService("RunService")
local userInput = game:GetService("UserInputService")

local autoFarm = false
local HIT_RANGE = 3

local function getClosestMob()
    local closestMob = nil
    local closestDistance = math.huge
    for _, mob in ipairs(workspace.Characters:GetChildren()) do
        if mob:IsA("Model") and mob ~= character and mob:FindFirstChild("HumanoidRootPart") then
            local dist = (mob.HumanoidRootPart.Position - humanoidRootPart.Position).Magnitude
            if dist < closestDistance then
                closestDistance = dist
                closestMob = mob
            end
        end
    end
    return closestMob
end

local function teleportUnderEnemy(mob)
    if humanoidRootPart and mob:FindFirstChild("HumanoidRootPart") then
        local yOffset = -7 -- Changed to negative to face downwards
        local targetCFrame = mob.HumanoidRootPart.CFrame 
            * CFrame.new(0, yOffset, 0)
            * CFrame.Angles(math.rad(-90), 0, 0) -- Changed 90 to -90 to face downwards
        humanoidRootPart.CFrame = targetCFrame
    end
end

local function isInRange(mob, range)
    local mobRootPart = mob:FindFirstChild("HumanoidRootPart")
    if not mobRootPart or not humanoidRootPart then return false end
    return (mobRootPart.Position - humanoidRootPart.Position).Magnitude <= range
end

local function equipWeapon()
    local args = {
        [1] = "Equip/UnEquip"
    }
    game:GetService("ReplicatedStorage"):WaitForChild("Events"):WaitForChild("WeaponsEvent"):FireServer(unpack(args))
end

equipWeapon()

local function useSkill(skillName)
    local args = {
        [1] = { ["Skill"] = skillName, ["Function"] = "Activate" },
        [2] = humanoidRootPart.Position,
        [3] = true
    }
    game:GetService("ReplicatedStorage"):WaitForChild("Events"):WaitForChild("Skill"):FireServer(unpack(args))
end

function attack()
    spawn(function()
        while autoFarm do
            local mob = getClosestMob()
            if mob then
                if not isInRange(mob, HIT_RANGE) then
                    teleportUnderEnemy(mob)
                end
                humanoidRootPart.Anchored = true
                game:GetService("ReplicatedStorage"):WaitForChild("Events"):WaitForChild("Combat")
                    :FireServer("Attack")
                useSkill("FlurryOfBlows")
                useSkill("BloodyCut")
                useSkill("Invisibility")
            end
            task.wait(0.1)
        end
    end)
end

function stopAutoFarm()
    autoFarm = false
    if humanoidRootPart then
        humanoidRootPart.Anchored = false
    end
end

local function enableNoFall()
    runService.Stepped:Connect(function()
        if autoFarm and humanoidRootPart then
            humanoidRootPart.Velocity = Vector3.new(0, 0, 0)
        end
    end)
end

enableNoFall()

userInput.InputBegan:Connect(function(input, gameProcessed)
    if not gameProcessed and input.KeyCode == Enum.KeyCode.Zero then
        stopAutoFarm()
    end
end)

-- Save config to settings.txt
MacLib:SaveConfig("settings.txt")

-- Load config on start
MacLib:LoadConfig("settings.txt")
